---
title: å®¹å™¨ä¸Bean
date: 2023-07-30 20:45:35
permalink: /pages/f344d070a1033aef
author: cynicism
categories:
  - ã€ŠSpring5åŸç†ã€‹
tags:
  - spring
---
## 1. å®¹å™¨æ¥å£
![](https://cdn.jsdelivr.net/gh/Cynicism-lab/MyResource@gh-pages/image/QQæˆªå›¾20230727212140.4l6gdeiyd0qo.webp)

* BeanFactory æ¥å£ï¼Œæ˜¯Springçš„æ ¸å¿ƒå®¹å™¨ï¼Œå…¸å‹åŠŸèƒ½æœ‰ï¼š
  * getBeanâ€”â€”è·å–å®¹å™¨ä¸­çš„bean
  * **æ§åˆ¶åè½¬**ã€åŸºæœ¬çš„**ä¾èµ–æ³¨å…¥**ã€ç›´è‡³ Bean çš„**ç”Ÿå‘½å‘¨æœŸ**çš„å„ç§åŠŸèƒ½ï¼Œéƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›
  * æˆå‘˜å˜é‡ singletonObjectsï¼Œå†…éƒ¨åŒ…å«äº†æ‰€æœ‰çš„å•ä¾‹ bean

* ApplicationContext æ¥å£ï¼Œæ˜¯ BeanFactory çš„å­æ¥å£ã€‚å®ƒæ‰©å±•äº† BeanFactory æ¥å£çš„åŠŸèƒ½ï¼Œå¦‚ï¼š
  * å›½é™…åŒ–â€”â€”**MessageSource**
  * é€šé…ç¬¦æ–¹å¼è·å–ä¸€ç»„ Resource èµ„æºâ€”â€”**ResourcePatternResolver**
  * æ•´åˆ Environment ç¯å¢ƒï¼ˆèƒ½é€šè¿‡å®ƒè·å–å„ç§æ¥æºçš„é…ç½®ä¿¡æ¯ï¼‰â€”â€”**EnvironmentCapable**
  * äº‹ä»¶å‘å¸ƒä¸ç›‘å¬ï¼Œå®ç°ç»„ä»¶ä¹‹é—´çš„è§£è€¦â€”â€”**ApplicationEventPublisher**

## 2. å®¹å™¨å®ç°
* DefaultListableBeanFactoryï¼Œæ˜¯ BeanFactory æœ€é‡è¦çš„å®ç°ï¼Œåƒ**æ§åˆ¶åè½¬**å’Œ**ä¾èµ–æ³¨å…¥**åŠŸèƒ½ï¼Œéƒ½æ˜¯å®ƒæ¥å®ç°
* ClassPathXmlApplicationContextï¼Œä»ç±»è·¯å¾„æŸ¥æ‰¾ XML é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå®¹å™¨ï¼ˆæ—§ï¼‰
* FileSystemXmlApplicationContextï¼Œä»ç£ç›˜è·¯å¾„æŸ¥æ‰¾ XML é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå®¹å™¨ï¼ˆæ—§ï¼‰
* XmlWebApplicationContextï¼Œä¼ ç»Ÿ SSM æ•´åˆæ—¶ï¼ŒåŸºäº XML é…ç½®æ–‡ä»¶çš„å®¹å™¨ï¼ˆæ—§ï¼‰
* AnnotationConfigWebApplicationContextï¼Œä¼ ç»Ÿ SSM æ•´åˆæ—¶ï¼ŒåŸºäº java é…ç½®ç±»çš„å®¹å™¨ï¼ˆæ—§ï¼‰
* **AnnotationConfigApplicationContext**ï¼ŒSpring boot ä¸­é web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰
* **AnnotationConfigServletWebServerApplicationContext**ï¼ŒSpring boot ä¸­ servlet web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰
* AnnotationConfigReactiveWebServerApplicationContextï¼ŒSpring boot ä¸­ reactive web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰

ğŸ”å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œåé¢è¿™äº›å¸¦æœ‰ ApplicationContext çš„ç±»éƒ½æ˜¯ ApplicationContext æ¥å£çš„å®ç°ï¼Œä½†å®ƒä»¬æ˜¯**ç»„åˆ**äº† DefaultListableBeanFactory çš„åŠŸèƒ½ï¼Œå¹¶éç»§æ‰¿è€Œæ¥

**æ”¶è·ğŸ’¡**
>beanFactoryæ˜¯DefaultListableBeanFactoryå®ç°çš„å®¹å™¨

* beanFactory å¯ä»¥é€šè¿‡ registerBeanDefinition æ³¨å†Œä¸€ä¸ª bean definition å¯¹è±¡
  * æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„é…ç½®ç±»ã€xmlã€ç»„ä»¶æ‰«æç­‰æ–¹å¼éƒ½æ˜¯ç”Ÿæˆ bean definition å¯¹è±¡æ³¨å†Œåˆ° beanFactory å½“ä¸­
  * bean definition æè¿°äº†è¿™ä¸ª bean çš„åˆ›å»ºè“å›¾ï¼šscope æ˜¯ä»€ä¹ˆã€ç”¨æ„é€ è¿˜æ˜¯å·¥å‚åˆ›å»ºã€åˆå§‹åŒ–é”€æ¯æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œç­‰ç­‰
* beanFactory éœ€è¦æ‰‹åŠ¨è°ƒç”¨ **beanFactory åå¤„ç†å™¨**å¯¹å®ƒåšå¢å¼º
  * ä¾‹å¦‚é€šè¿‡è§£æ @Beanã€@ComponentScan ç­‰æ³¨è§£ï¼Œæ¥è¡¥å……ä¸€äº› bean definitionï¼ˆç¬¬ä¸‰æ–¹beanï¼‰
* beanFactory éœ€è¦æ‰‹åŠ¨æ·»åŠ  **bean åå¤„ç†å™¨**ï¼Œä»¥ä¾¿å¯¹åç»­ bean çš„åˆ›å»ºè¿‡ç¨‹æä¾›å¢å¼º
  * ä¾‹å¦‚ @Autowiredï¼Œ@Resource ç­‰æ³¨è§£çš„è§£æéƒ½æ˜¯ bean åå¤„ç†å™¨å®Œæˆçš„
  * bean åå¤„ç†çš„æ·»åŠ é¡ºåºä¼šå¯¹è§£æç»“æœæœ‰å½±å“ï¼Œ@Autowiredæ¯”@Resourceå…ˆç”Ÿæ•ˆ
* beanFactory éœ€è¦æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æ¥åˆå§‹åŒ–å•ä¾‹
* beanFactory éœ€è¦é¢å¤–è®¾ç½®æ‰èƒ½è§£æ ${} ä¸ #{}

## 3. Beançš„ç”Ÿå‘½å‘¨æœŸ
ä¸€ä¸ªå— Spring ç®¡ç†çš„ beanï¼Œç”Ÿå‘½å‘¨æœŸä¸»è¦é˜¶æ®µæœ‰

1. **åˆ›å»º**ï¼šæ ¹æ® bean çš„æ„é€ æ–¹æ³•æˆ–è€…å·¥å‚æ–¹æ³•æ¥åˆ›å»º bean å®ä¾‹å¯¹è±¡
2. **ä¾èµ–æ³¨å…¥**ï¼šæ ¹æ® @Autowiredï¼Œ@Value æˆ–å…¶å®ƒä¸€äº›æ‰‹æ®µï¼Œä¸º bean çš„æˆå‘˜å˜é‡å¡«å……å€¼ã€å»ºç«‹å…³ç³»
3. **åˆå§‹åŒ–**ï¼šå›è°ƒå„ç§ Aware æ¥å£ï¼Œè°ƒç”¨å¯¹è±¡çš„å„ç§åˆå§‹åŒ–æ–¹æ³•
4. **é”€æ¯**ï¼šåœ¨å®¹å™¨å…³é—­æ—¶ï¼Œä¼šé”€æ¯æ‰€æœ‰å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨å®ƒä»¬çš„é”€æ¯æ–¹æ³•ï¼‰
   * prototype å¯¹è±¡ä¹Ÿèƒ½å¤Ÿé”€æ¯ï¼Œä¸è¿‡éœ€è¦å®¹å™¨è¿™è¾¹ä¸»åŠ¨è°ƒç”¨

>ç”Ÿå‘½å‘¨æœŸä¸­è¿˜æœ‰ä¸€ç±» bean åå¤„ç†å™¨ï¼šBeanPostProcessorï¼Œä¼šåœ¨ bean çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸçš„å‰åï¼Œæä¾›ä¸€äº›æ‰©å±•é€»è¾‘

åˆ›å»ºå‰åçš„å¢å¼º
* postProcessBeforeInstantiation
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡è‹¥ä¸ä¸º null ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ beanï¼Œå¹¶ä¸”ä»…ä¼šèµ° postProcessAfterInitialization æµç¨‹
* postProcessAfterInstantiation
  * è¿™é‡Œå¦‚æœè¿”å› false ä¼šè·³è¿‡ä¾èµ–æ³¨å…¥é˜¶æ®µ

ä¾èµ–æ³¨å…¥å‰çš„å¢å¼º
* postProcessProperties
  * å¦‚ @Autowiredã€@Valueã€@Resource 

åˆå§‹åŒ–å‰åçš„å¢å¼º
* postProcessBeforeInitialization
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ bean
  * å¦‚ @PostConstructã€@ConfigurationProperties
* postProcessAfterInitialization 
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ bean
  * å¦‚ä»£ç†å¢å¼º

é”€æ¯ä¹‹å‰çš„å¢å¼º
* postProcessBeforeDestruction
  * å¦‚ @PreDestroy 
  
## 4. Bean åå¤„ç†å™¨
>@Autowired ç­‰æ³¨è§£çš„è§£æå±äº bean ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼ˆä¾èµ–æ³¨å…¥, åˆå§‹åŒ–ï¼‰çš„æ‰©å±•åŠŸèƒ½ï¼Œè¿™äº›æ‰©å±•åŠŸèƒ½ç”± bean åå¤„ç†å™¨æ¥å®Œæˆ

1. æ¯ä¸ªåå¤„ç†å™¨å„è‡ªå¢å¼ºä»€ä¹ˆåŠŸèƒ½
   * **AutowiredAnnotationBeanPostProcessor** è§£æ @Autowired ä¸ @Value
   * **CommonAnnotationBeanPostProcessor** è§£æ @Resourceã€@PostConstructã€@PreDestroy
   * **ConfigurationPropertiesBindingPostProcessor** è§£æ @ConfigurationProperties
2. å¦å¤– ContextAnnotationAutowireCandidateResolver è´Ÿè´£è·å– @Value çš„å€¼ï¼Œè§£æ @Qualifierã€æ³›å‹ã€@Lazy ç­‰

**è¡¥å……ï¼šAutowiredAnnotationBeanPostProcessorä¾èµ–æ³¨å…¥åŸç†**
1. AutowiredAnnotationBeanPostProcessor.findAutowiringMetadata ç”¨æ¥è·å–æŸä¸ª bean ä¸ŠåŠ äº† @Value @Autowired çš„æˆå‘˜å˜é‡ï¼Œæ–¹æ³•å‚æ•°çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºä¸º InjectionMetadata
2. InjectionMetadata å¯ä»¥å®Œæˆä¾èµ–æ³¨å…¥
3. InjectionMetadata å†…éƒ¨æ ¹æ®æˆå‘˜å˜é‡ï¼Œæ–¹æ³•å‚æ•°å°è£…ä¸º DependencyDescriptor ç±»å‹
4. æœ‰äº† DependencyDescriptorï¼Œå°±å¯ä»¥åˆ©ç”¨ beanFactory.doResolveDependency æ–¹æ³•è¿›è¡ŒåŸºäºç±»å‹çš„æŸ¥æ‰¾

## 5. BeanFactory åå¤„ç†å™¨
>@ComponentScan, @Bean, @Mapper ç­‰æ³¨è§£çš„è§£æå±äºæ ¸å¿ƒå®¹å™¨ï¼ˆå³ BeanFactoryï¼‰çš„æ‰©å±•åŠŸèƒ½ï¼Œä¸»è¦å°±æ˜¯è¡¥å……äº†ä¸€äº› bean å®šä¹‰

* ConfigurationClassPostProcessor å¯ä»¥è§£æ
  * @ComponentScan
  * @Bean
  * @Import
  * @ImportResource
* MapperScannerConfigurer å¯ä»¥è§£æ
  * Mapper æ¥å£

### 5.1 @ComponentScanè§£æ
1. Spring æ“ä½œå…ƒæ•°æ®çš„å·¥å…·ç±» CachingMetadataReaderFactory
2. é€šè¿‡**æ³¨è§£å…ƒæ•°æ®**ï¼ˆAnnotationMetadataï¼‰è·å–ç›´æ¥(@Component)æˆ–é—´æ¥(Controller)æ ‡æ³¨çš„æ³¨è§£ä¿¡æ¯
3. é€šè¿‡**ç±»å…ƒæ•°æ®**ï¼ˆClassMetadataï¼‰è·å–ç±»åï¼ŒAnnotationBeanNameGenerator ç”Ÿæˆ bean å
4. è§£æå…ƒæ•°æ®æ˜¯åŸºäº ASM æŠ€æœ¯ (**Javaå­—èŠ‚ç æ“ä½œæ¡†æ¶**)

>ASMæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å­—èŠ‚ç å·¥å…·ï¼Œç”¨äºåˆ†æã€ä¿®æ”¹å’Œç”ŸæˆJavaç±»æ–‡ä»¶çš„å­—èŠ‚ç ã€‚å®ƒå¯ä»¥è®©å¼€å‘è€…åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ£€æŸ¥å’Œæ“ä½œç±»çš„ç»“æ„ã€å­—æ®µã€æ–¹æ³•ä»¥åŠæ³¨è§£ç­‰å…ƒæ•°æ®ä¿¡æ¯ã€‚
é€šè¿‡ASMï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨å­—èŠ‚ç çº§åˆ«çš„æ“ä½œæ¥è§£æå’Œå¤„ç†ç±»çš„å…ƒæ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ASMæ¥æå–ç±»çš„æ³¨è§£ä¿¡æ¯ï¼Œè·å–ç±»çš„å­—æ®µå’Œæ–¹æ³•ä¿¡æ¯ï¼Œç”šè‡³å¯ä»¥ä¿®æ”¹å­—èŠ‚ç æ¥æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤å…ƒæ•°æ®ã€‚

### 5.2 @Mapperè§£æ
1. Mapper æ¥å£è¢« Spring ç®¡ç†çš„æœ¬è´¨ï¼šå®é™…æ˜¯è¢«ä½œä¸º **MapperFactoryBean** æ³¨å†Œåˆ°å®¹å™¨ä¸­
2. Spring çš„è¯¡å¼‚åšæ³•ï¼Œæ ¹æ®æ¥å£ç”Ÿæˆçš„ BeanDefinition ä»…ä¸ºæ ¹æ®æ¥å£åç”Ÿæˆ bean å

## 6. Aware æ¥å£
1. Aware æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘ çš„æ³¨å…¥æ‰‹æ®µï¼Œä¾‹å¦‚
   * BeanNameAware æ³¨å…¥ bean çš„åå­—
   * BeanFactoryAware æ³¨å…¥ BeanFactory å®¹å™¨
   * ApplicationContextAware æ³¨å…¥ ApplicationContext å®¹å™¨
   * EmbeddedValueResolverAware æ³¨å…¥ ${} è§£æå™¨
2. InitializingBean æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘çš„åˆå§‹åŒ–ï¼ˆç›¸å½“äºæ„é€ å‡½æ•°åˆå§‹åŒ–ï¼‰
3. å¯¹æ¯”
   * å†…ç½®çš„æ³¨å…¥å’Œåˆå§‹åŒ–ä¸å—æ‰©å±•åŠŸèƒ½çš„å½±å“ï¼Œ**æ€»ä¼šè¢«æ‰§è¡Œ**
   * è€Œæ‰©å±•åŠŸèƒ½å—æŸäº›æƒ…å†µå½±å“**å¯èƒ½ä¼šå¤±æ•ˆ**
   * å› æ­¤ Spring æ¡†æ¶å†…éƒ¨çš„ç±»å¸¸ç”¨å†…ç½®æ³¨å…¥å’Œåˆå§‹åŒ–

## 7. åˆå§‹åŒ–ä¸é”€æ¯
Spring æä¾›äº†å¤šç§åˆå§‹åŒ–æ‰‹æ®µï¼Œé™¤äº†è¯¾å ‚ä¸Šè®²çš„ @PostConstructï¼Œ@Bean(initMethod) ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° InitializingBean æ¥å£æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœåŒä¸€ä¸ª bean ç”¨äº†ä»¥ä¸Šæ‰‹æ®µå£°æ˜äº† 3 ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯

1. @PostConstruct æ ‡æ³¨çš„åˆå§‹åŒ–æ–¹æ³•
2. InitializingBean æ¥å£çš„åˆå§‹åŒ–æ–¹æ³•
3. @Bean(initMethod) æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•

ä¸åˆå§‹åŒ–ç±»ä¼¼ï¼ŒSpring ä¹Ÿæä¾›äº†å¤šç§é”€æ¯æ‰‹æ®µï¼Œæ‰§è¡Œé¡ºåºä¸º
1. @PreDestroy æ ‡æ³¨çš„é”€æ¯æ–¹æ³•
2. DisposableBean æ¥å£çš„é”€æ¯æ–¹æ³•
3. @Bean(destroyMethod) æŒ‡å®šçš„é”€æ¯æ–¹æ³•

## 8. Scope 
åœ¨å½“å‰ç‰ˆæœ¬çš„ Spring å’Œ Spring Boot ç¨‹åºä¸­ï¼Œæ”¯æŒäº”ç§ Scope
* singletonï¼Œå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºï¼ˆæœªè®¾ç½®å»¶è¿Ÿï¼‰ï¼Œå®¹å™¨å…³é—­æ—¶é”€æ¯
* prototypeï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºï¼Œä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦è°ƒç”¨ DefaultListableBeanFactory.destroyBean(bean) é”€æ¯
* requestï¼Œæ¯æ¬¡è¯·æ±‚ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œè¯·æ±‚ç»“æŸæ—¶é”€æ¯ï¼ˆwebï¼‰
* sessionï¼Œæ¯ä¸ªä¼šè¯ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œä¼šè¯ç»“æŸæ—¶é”€æ¯ï¼ˆwebï¼‰
* applicationï¼Œweb å®¹å™¨ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œå®¹å™¨åœæ­¢æ—¶é”€æ¯ï¼ˆwebï¼‰

>ğŸ”å¦‚æœåœ¨ singleton æ³¨å…¥å…¶å®ƒ scope éƒ½ä¼šæœ‰é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æœ‰

* @Lazyï¼ˆä¾èµ–æ³¨å…¥æ—¶ä½¿ç”¨ï¼‰
* @Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)
* ObjectFactory
* ApplicationContext.getBean

**åˆ†æå¤±æ•ˆåŸå› ï¼š**
![](https://cdn.jsdelivr.net/gh/Cynicism-lab/MyResource@gh-pages/image/QQæˆªå›¾20230730195342.6j0xhd33ksu8.webp)

