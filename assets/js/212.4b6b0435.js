(window.webpackJsonp=window.webpackJsonp||[]).push([[212],{572:function(t,e,r){"use strict";r.r(e);var i=r(8),n=Object(i.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("详情查看："),e("a",{attrs:{href:"https://cyborg2077.github.io/2023/03/08/XuechengOnlinePart5/",target:"_blank",rel:"noopener noreferrer"}},[t._v("认证授权服务"),e("OutboundLink")],1)]),t._v(" "),e("h2",{attrs:{id:"_1-介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-介绍"}},[t._v("#")]),t._v(" 1. 介绍")]),t._v(" "),e("blockquote",[e("p",[t._v("什么是用户身份认证？")])]),t._v(" "),e("p",[t._v("用户身份认证即当用户访问系统资源时，系统要求验证用户的身份信息，身份合法方可继续访问，在SpringCloud gateway实现")]),t._v(" "),e("blockquote",[e("p",[t._v("什么是用户授权？")])]),t._v(" "),e("p",[t._v("用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。例如用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限")]),t._v(" "),e("h2",{attrs:{id:"_2-业务流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-业务流程"}},[t._v("#")]),t._v(" 2. 业务流程")]),t._v(" "),e("blockquote",[e("p",[t._v("项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Cynicism-lab/MyResource/img/ppuMFdf.png",alt:""}})]),t._v(" "),e("p",[t._v("有访问微服务的请求都要经过网关，在网关进行用户身份的认证，可以将很多非法的请求拦截到微服务以外，这叫做网关鉴权")]),t._v(" "),e("p",[e("strong",[t._v("网关鉴权的职责")])]),t._v(" "),e("ul",[e("li",[t._v("网站白名单维护：针对不用认证的URL全部放行（例如请求认证的请求就在白名单内，会访问授权认证微服务模块）")]),t._v(" "),e("li",[t._v("校验JWT的合法性：除了白名单剩下的就是需要认证的请求，网关需要验证JWT的合法性，JWT合法则说明用户身份合法，否则说明身份不合法，拒绝继续访问")])]),t._v(" "),e("blockquote",[e("p",[t._v("网关不负责授权，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口")])]),t._v(" "),e("h2",{attrs:{id:"_3-工作原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-工作原理"}},[t._v("#")]),t._v(" 3. 工作原理")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Cynicism-lab/MyResource/img/ppnetIJ.png",alt:""}})]),t._v(" "),e("ol",[e("li",[t._v("用户提交用户名、密码被SecurityFilterChain中的UsernamePasswordAuthenticationFilter"),e("strong",[t._v("过滤器获取")]),t._v("到，封装为请求Authentication")]),t._v(" "),e("li",[t._v("然后过滤器将Authentication提交至认证管理器(AuthenticationManager)进行认证, 然后DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法根据用户名从"),e("strong",[t._v("数据库中获取")]),t._v("UserDetails用户信息对比认证")]),t._v(" "),e("li",[t._v("认证成功后，AuthenticationManager身份管理器返回一个被填充满了信息（"),e("strong",[t._v("权限信息、身份信息、细节信息等")]),t._v("，但密码通常会被移除）的Authentication实例")]),t._v(" "),e("li",[t._v("SecurityContextHolder将第三步填充了信息的Authentication通过SecurityContextHolder.getContext().setAuthentication()方法，设置到其中。")])]),t._v(" "),e("p",[e("mark",[t._v("返回的Authentication实例就是颁发的令牌，令牌中已经包含了用户拥有的资源访问权限，后续微服务接口中只需要解析令牌就可以判断用户是否具有权限访问")])]),t._v(" "),e("blockquote",[e("p",[t._v("我们需要扩展用户身份信息，在JWT令牌中存储用户的昵称、头像、QQ等信息如何扩展Spring Security的用户身份信息呢？")])]),t._v(" "),e("p",[t._v("在认证阶段DaoAuthenticationProvider会调用UserDetailsService查询用户的信息，这里是可以获取到齐全的用户信息。")]),t._v(" "),e("p",[t._v("由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路")]),t._v(" "),e("ul",[e("li",[t._v("扩展UserDetails，包括更多的自定义属性")]),t._v(" "),e("li",[t._v("扩展username的内容，例如存入Json数据作为username的内容(容易实现，也不用破坏UserDetails的结构)")])])])}),[],!1,null,null,null);e.default=n.exports}}]);